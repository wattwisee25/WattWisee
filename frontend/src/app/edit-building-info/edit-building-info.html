<header>
  <app-menu></app-menu>
</header>

<div class="edit-building-container" *ngIf="!isLoading; else loading">
  <h2>Edit Building Info</h2>
  <div *ngIf="errorMessage" class="error">{{ errorMessage }}</div>

  <form (ngSubmit)="saveBuilding()">

    <!-- ===== GENERAL INFO ===== -->
    <section class="card">
      <h3>General Info</h3>
      <div class="input-grid">
        <div class="input-container">
          <input type="text" placeholder=" " [(ngModel)]="building.name" name="name">
          <label>Name</label>
        </div>
        <div class="input-container">
          <input type="text" placeholder=" " [(ngModel)]="building.generalInfo.mprn" name="mprn">
          <label>MPRN</label>
        </div>
        <div class="input-container">
          <input type="text" placeholder=" " [(ngModel)]="building.generalInfo.address" name="address">
          <label>Address</label>
        </div>
        <div class="input-container">
          <input type="text" placeholder=" " [(ngModel)]="building.generalInfo.city" name="city">
          <label>City</label>
        </div>
        <div class="input-container">
          <input type="text" placeholder=" " [(ngModel)]="building.generalInfo.eircode" name="eircode">
          <label>Eircode</label>
        </div>
        <div class="input-container">
          <input type="text" placeholder=" " [(ngModel)]="building.buildingEnvelope.buildingType" name="buildingType">
          <label>Building Type</label>
        </div>
        <div class="input-container">
          <input type="number" placeholder=" " [(ngModel)]="building.buildingEnvelope.yearBuilt" name="yearBuilt">
          <label>Year Built</label>
        </div>
      </div>
    </section>

    <!-- ===== ADDITIONAL DETAILS ===== -->
    <section class="card">
      <h3>Add Details</h3>
      <div class="actions" style="flex-wrap: wrap; gap: 10px;">
        <button type="button" (click)="toggleForm('room')">Rooms</button>
        <button type="button" (click)="toggleForm('lighting')">Lighting</button>
        <button type="button" (click)="toggleForm('aux')">Auxiliary</button>
        <button type="button" (click)="toggleForm('seu')">SEU</button>
      </div>

      <!-- ===== CONDITIONAL FORMS ===== -->
      <!-- Room preview -->
      <div *ngIf="activeForm === 'room'">
        <div class="scrollable-horizontal">
          <div class="sub-card" *ngFor="let room of building.buildingEnvelope.rooms || []; let ri = index">
            <h4>{{ room.name }}</h4>
            <p>
              Walls: {{ room.walls?.length || 0 }} |
              <!-- Windows: {{ room.windows?.length || 0 }} |
              Doors: {{ room.doors?.length || 0 }} | -->
              Windows: {{ getRoomWindowsCount(room) }} |
              Doors: {{ getRoomDoorsCount(room) }} |
              Roofs: {{ room.roofs?.length || 0 }}
            </p>
            <button type="button" (click)="editRoom(ri)">Edit Room</button>
          </div>
        </div>
        <button type="button" (click)="addRoom()">+ Add Room</button>
      </div>

      <!-- Lighting form -->
      <div *ngIf="activeForm === 'lighting'">
        <div class="scrollable">
          <div *ngFor="let light of building.lighting || []; let li = index" class="sub-card">
            <div class="input-grid">
              <div class="input-container">
                <input type="text" placeholder=" " [(ngModel)]="light.lightingType" [name]="'lightType'+li">
                <label>Lighting Type</label>
              </div>
              <div class="input-container">
                <input type="number" placeholder=" " [(ngModel)]="light.number" [name]="'lightNumber'+li">
                <label>Number</label>
              </div>
              <div class="input-container">
                <input type="text" placeholder=" " [(ngModel)]="light.lightingControls" [name]="'lightControls'+li">
                <label>Controls</label>
              </div>
              <div class="input-container">
                <input type="number" placeholder=" " [(ngModel)]="light.totalEnergyUsed" [name]="'lightTotalEnergy'+li">
                <label>Total Energy</label>
              </div>
            </div>
          </div>
        </div>
        <button type="button" (click)="addLighting()">+ Add Lighting</button>
      </div>

      <!-- Auxiliary form -->
      <div *ngIf="activeForm === 'aux'">
        <div class="scrollable">
          <div *ngFor="let aux of building.auxiliaryUsage || []; let ai = index" class="sub-card">
            <div class="input-grid">
              <div class="input-container">
                <input type="number" placeholder=" " [(ngModel)]="aux.currentUsage" [name]="'auxCurrent'+ai">
                <label>Current Usage</label>
              </div>
              <div class="input-container">
                <input type="number" placeholder=" " [(ngModel)]="aux.baselineUsage" [name]="'auxBaseline'+ai">
                <label>Baseline Usage</label>
              </div>
              <div class="input-container">
                <input type="text" placeholder=" " [(ngModel)]="aux.lightingControls" [name]="'auxLighting'+ai">
                <label>Lighting Controls</label>
              </div>
              <div class="input-container">
                <input type="number" placeholder=" " [(ngModel)]="aux.totalEnergyUsed" [name]="'auxTotalEnergy'+ai">
                <label>Total Energy</label>
              </div>
            </div>
          </div>
        </div>
        <button type="button" (click)="addAuxiliary()">+ Add Auxiliary</button>
      </div>

      <!-- SEU form -->
      <div *ngIf="activeForm === 'seu'">
        <div class="scrollable">
          <div *ngFor="let seu of building.significantEnergyUsers || []; let si = index" class="sub-card">
            <div class="input-grid">
              <div class="input-container">
                <input type="text" placeholder=" " [(ngModel)]="seu.name" [name]="'seuName'+si">
                <label>Name</label>
              </div>
              <div class="input-container">
                <input type="number" placeholder=" " [(ngModel)]="seu.consumption" [name]="'seuConsumption'+si">
                <label>Consumption</label>
              </div>
              <div class="input-container">
                <input type="text" placeholder=" " [(ngModel)]="seu.efficiency" [name]="'seuEfficiency'+si">
                <label>Efficiency</label>
              </div>
              <div class="input-container">
                <input type="text" placeholder=" " [(ngModel)]="seu.notes" [name]="'seuNotes'+si">
                <label>Notes</label>
              </div>
            </div>
          </div>
        </div>
        <button type="button" (click)="addSEU()">+ Add SEU</button>
      </div>

    </section>

    <div class="actions">
      <button type="submit" class="save">Save Building</button>
    </div>
  </form>
</div>

<!-- ===== ROOM MODAL ===== -->
<div class="modal" *ngIf="showRoomModal">
  <div class="modal-content scrollable">
    <h3>{{ editingRoomIndex !== null ? 'Edit Room' : 'Add Room' }}</h3>

    <!-- Room Name -->
    <div class="input-container">
      <input type="text" placeholder=" " [(ngModel)]="roomForm.name" name="roomName">
      <label>Room Name</label>
    </div>

    <div class="modal-buttons">
      <button class="modal-btn" type="button" (click)="addWallToForm()">+ Add Wall</button>
      <!-- <button class="modal-btn" type="button" (click)="addWindowToForm()">+ Add Window</button>
      <button class="modal-btn" type="button" (click)="addDoorToForm()">+ Add Door</button> -->
      <button class="modal-btn" type="button" (click)="addRoofToForm()">+ Add Roof</button>
    </div>

    <!-- ===== WALLS ===== -->
    <div *ngFor="let wall of roomForm.walls || []; let wi = index" class="sub-card nested">
      <div class="wall-header">
        <h5>Wall {{ wi + 1 }}</h5>
        <div class="wall-header-buttons">
          <button type="button" (click)="addWindowToWall(wall)">
            + Add Window to this Wall
          </button>
          <button type="button" (click)="addDoorToWall(wall)">
            + Add Door to this Wall
          </button>
        </div>
      </div>
      <div class="input-grid">
        <div class="input-container">
          <input type="number" placeholder=" " [(ngModel)]="wall.totalArea" [name]="'wallTotalArea'+wi">
          <label>Total Area</label>
        </div>
        <div class="input-container">
          <input type="number" placeholder=" " [(ngModel)]="wall.number" [name]="'wallNumber'+wi">
          <label>Number</label>
        </div>
      </div>
      <div class="input-container">
        <select [(ngModel)]="wall.orientation" name="wallOrientation{{wi}}">
          <option value="North">North</option>
          <option value="South">South</option>
          <option value="East">East</option>
          <option value="West">West</option>
        </select>
        <label>Orientation</label>
      </div>

      <div class="input-container">
        <select [(ngModel)]="wall.exposure" name="wallExposure{{wi}}">
          <option value="exterior">Exterior</option>
          <option value="interior">Interior</option>
        </select>
        <label>Exposure</label>
      </div>

      <div *ngFor="let detail of wall.wallsDetails || []; let di = index" class="sub-card nested">
        <h6>Detail {{ di + 1 }}</h6>
        <div class="input-grid">
          <div class="input-container">
            <input type="text" placeholder=" " [(ngModel)]="detail.constructionType"
              [name]="'wallConstructionType'+wi+di">
            <label>Construction Type</label>
          </div>
          <div class="input-container">
            <input type="text" placeholder=" " [(ngModel)]="detail.insulationMaterials" [name]="'wallInsulation'+wi+di">
            <label>Insulation Materials</label>
          </div>
          <div class="input-container">
            <input type="text" placeholder=" " [(ngModel)]="detail.insideMaterials"
              [name]="'wallInsideMaterials'+wi+di">
            <label>Inside Materials</label>
          </div>
          <div class="input-container">
            <input type="text" placeholder=" " [(ngModel)]="detail.constructionMaterials"
              [name]="'wallConstructionMaterials'+wi+di">
            <label>Construction Materials</label>
          </div>
          <div class="input-container">
            <!-- <input type="number" [(ngModel)]="detail.area" (ngModelChange)="calculateWallHeatLoss(wall, detail)">
            <label>Area (m²)</label> -->
            <input type="number" [value]="detail.area" readonly>
            <label>Net Area (m²)</label>
          </div>
          <div class="input-container">
            <input type="number" [(ngModel)]="detail.uValue" (ngModelChange)="calculateWallHeatLoss(wall, detail)">
            <label>U-Value</label>
          </div>
          <div class="input-container">
            <input type="number" [value]="detail.heatLossWK" readonly>
            <label>Heat Loss (W/K)</label>
          </div>


          <div *ngFor="let window of wall.windows; let wi2 = index" class="sub-card nested">
            <h6>Window {{ wi2 + 1 }}</h6>
            <!-- Area Window -->
            <div class="input-container">
              <input type="number" [(ngModel)]="window.totalArea"
                (ngModelChange)="calculateWallHeatLoss(wall, wall.wallsDetails[0])">
              <label>Window Area (m²)</label>
            </div>

            <!-- Window Details -->
            <div *ngFor="let detail of window.windowsDetails; let wdi = index" class="sub-card nested">
              <h6>Detail {{ wdi + 1 }}</h6>

              <div class="input-grid">
                <div class="input-container">
                  <input type="text" [(ngModel)]="detail.windowType">
                  <label>Window Type</label>
                </div>

                <div class="input-container">
                  <input type="number" [(ngModel)]="detail.uValue">
                  <label>U-Value</label>
                </div>

                <div class="input-container">
                  <input type="number" [(ngModel)]="detail.solarGain">
                  <label>Solar Gain</label>
                </div>

                <div class="input-container">
                  <select [(ngModel)]="detail.orientation">
                    <option value="North">North</option>
                    <option value="South">South</option>
                    <option value="East">East</option>
                    <option value="West">West</option>
                  </select>
                  <label>Orientation</label>
                </div>
              </div>
            </div>
          </div>

          <div *ngFor="let door of wall.doors; let di2 = index" class="sub-card nested">
            <h6>Door {{ di2 + 1 }}</h6>

            <!-- Area -->
            <div class="input-container">
              <input type="number" [(ngModel)]="door.totalArea"
                (ngModelChange)="calculateWallHeatLoss(wall, wall.wallsDetails[0])">
              <label>Door Area (m²)</label>
            </div>

            <!-- Door Details -->
            <div *ngFor="let detail of door.doorsDetails; let ddi = index" class="sub-card nested">
              <h6>Detail {{ ddi + 1 }}</h6>

              <div class="input-grid">
                <div class="input-container">
                  <input type="text" [(ngModel)]="detail.doorType">
                  <label>Door Type</label>
                </div>

                <div class="input-container">
                  <input type="number" [(ngModel)]="detail.uValue">
                  <label>U-Value</label>
                </div>

                <div class="input-container">
                  <input type="text" [(ngModel)]="detail.doorSealingMechanism">
                  <label>Sealing</label>
                </div>

                <div class="input-container">
                  <input type="text" [(ngModel)]="detail.doorLeakTest">
                  <label>Leak Test</label>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>


    <!-- ===== WINDOWS ===== -->
    <!-- <div *ngFor="let window of roomForm.windows || []; let wi = index" class="sub-card nested">
      <h5>Window {{ wi + 1 }}</h5>
      <div class="input-grid">
        <div class="input-container">
          <input type="number" placeholder=" " [(ngModel)]="window.totalArea" [name]="'windowTotalArea'+wi">
          <label>Total Area</label>
        </div>
        <div class="input-container">
          <input type="number" placeholder=" " [(ngModel)]="window.number" [name]="'windowNumber'+wi">
          <label>Number</label>
        </div>
      </div>
      <div *ngFor="let detail of window.windowsDetails || []; let di = index" class="sub-card nested">
        <h6>Detail {{ di + 1 }}</h6>
        <div class="input-grid">
          <div class="input-container">
            <input type="text" placeholder=" " [(ngModel)]="detail.windowType" [name]="'windowType'+wi+di">
            <label>Window Type</label>
          </div>
          <div class="input-container">
            <input type="number" placeholder=" " [(ngModel)]="detail.uValue" [name]="'windowUValue'+wi+di">
            <label>U-Value</label>
          </div>
          <div class="input-container">
            <input type="number" placeholder=" " [(ngModel)]="detail.solarGain" [name]="'windowSolarGain'+wi+di">
            <label>Solar Gain</label>
          </div>
          <div class="input-container">
            <select [(ngModel)]="detail.orientation" [name]="'windowOrientation'+wi+di">
              <option *ngFor="let dir of ['Nord','Nord-Est','Est','Sud-Est','Sud','Sud-Ovest','Ovest','Nord-Ovest']"
                [value]="dir">{{ dir }}</option>
            </select>
            <label>Orientation</label>
          </div>
          <div class="input-container">
            <input type="number" placeholder=" " [(ngModel)]="detail.heatLoss" [name]="'windowHeatLoss'+wi+di">
            <label>Heat Loss</label>
          </div>
        </div>
      </div>
    </div> -->


    <!-- ===== DOORS ===== -->
    <!-- <div *ngFor="let door of roomForm.doors || []; let di = index" class="sub-card nested">
      <h5>Door {{ di + 1 }}</h5>
      <div class="input-grid">
        <div class="input-container">
          <input type="number" placeholder=" " [(ngModel)]="door.totalArea" [name]="'doorTotalArea'+di">
          <label>Total Area</label>
        </div>
        <div class="input-container">
          <input type="number" placeholder=" " [(ngModel)]="door.number" [name]="'doorNumber'+di">
          <label>Number</label>
        </div>
      </div>
      <div *ngFor="let detail of door.doorsDetails || []; let ddi = index" class="sub-card nested">
        <h6>Detail {{ ddi + 1 }}</h6>
        <div class="input-grid">
          <div class="input-container">
            <input type="text" placeholder=" " [(ngModel)]="detail.doorType" [name]="'doorType'+di+ddi">
            <label>Door Type</label>
          </div>
          <div class="input-container">
            <input type="number" placeholder=" " [(ngModel)]="detail.uValue" [name]="'doorUValue'+di+ddi">
            <label>U-Value</label>
          </div>
          <div class="input-container">
            <input type="text" placeholder=" " [(ngModel)]="detail.doorSealingMechanism" [name]="'doorSealing'+di+ddi">
            <label>Sealing</label>
          </div>
          <div class="input-container">
            <input type="text" placeholder=" " [(ngModel)]="detail.doorLeakTest" [name]="'doorLeak'+di+ddi">
            <label>Leak Test</label>
          </div>
          <div class="input-container">
            <input type="number" placeholder=" " [(ngModel)]="detail.heatLoss" [name]="'doorHeatLoss'+di+ddi">
            <label>Heat Loss</label>
          </div>
        </div>
      </div>
    </div> -->


    <!-- ===== ROOFS ===== -->
    <div *ngFor="let roof of roomForm.roofs || []; let ri = index" class="sub-card nested">
      <h5>Roof {{ ri + 1 }}</h5>
      <div class="input-grid">
        <div class="input-container">
          <input type="number" placeholder=" " [(ngModel)]="roof.totalArea" [name]="'roofTotalArea'+ri">
          <label>Total Area</label>
        </div>
        <div class="input-container">
          <input type="number" placeholder=" " [(ngModel)]="roof.number" [name]="'roofNumber'+ri">
          <label>Number</label>
        </div>
      </div>
      <div *ngFor="let detail of roof.roofsDetails || []; let rdi = index" class="sub-card nested">
        <h6>Detail {{ rdi + 1 }}</h6>
        <div class="input-grid">
          <div class="input-container">
            <input type="text" placeholder=" " [(ngModel)]="detail.insulationType" [name]="'insulationType'+ri+rdi">
            <label>Insulation Type</label>
          </div>
          <div class="input-container">
            <input type="number" placeholder=" " [(ngModel)]="detail.area" [name]="'roofArea'+ri+rdi">
            <label>Area</label>
          </div>
          <div class="input-container">
            <input type="number" placeholder=" " [(ngModel)]="detail.uValue" [name]="'roofUValue'+ri+rdi">
            <label>U-Value</label>
          </div>
          <div class="input-container">
            <input type="number" placeholder=" " [(ngModel)]="detail.heatLoss" [name]="'roofHeatLoss'+ri+rdi">
            <label>Heat Loss</label>
          </div>
        </div>
      </div>
    </div>



    <!-- ===== MODAL ACTIONS ===== -->
    <div class="modal-actions">
      <button type="button" (click)="saveRoom()">Save Room</button>
      <button type="button" (click)="closeRoomModal()">Cancel</button>
    </div>
  </div>
</div>


<ng-template #loading>
  <p class="loading">Loading building data...</p>
</ng-template>

<div class="back-button">
  <app-back-button></app-back-button>
</div>